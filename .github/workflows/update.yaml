name: update-g-hub-list
run-name: Check and update list
on:
  schedule:
    - cron: "0 12 * * *"
  workflow_dispatch:
jobs:
  update-g-hub-list:
    runs-on: windows-latest
    steps:
    - name: Download installer
      run: |
        set INSTALLER_URL=https://download01.logi.com/web/ftp/pub/techsupport/gaming/lghub_installer.exe
        curl -L -o %TEMP%\installer.exe %INSTALLER_URL%
      shell: cmd

    - name: Verify installer security
      run: |
        $installerPath = "$env:TEMP\installer.exe"

        # Check file exists and has reasonable size (at least 1MB, at most 500MB)
        if (-not (Test-Path $installerPath)) {
          Write-Error "Installer file not found"
          exit 1
        }

        $fileSize = (Get-Item $installerPath).Length
        $fileSizeMB = [math]::Round($fileSize / 1MB, 2)
        Write-Host "Installer size: $fileSizeMB MB"

        if ($fileSize -lt 1MB) {
          Write-Error "Installer file is too small ($fileSizeMB MB) - possibly corrupted"
          exit 1
        }

        if ($fileSize -gt 500MB) {
          Write-Error "Installer file is suspiciously large ($fileSizeMB MB)"
          exit 1
        }

        # Verify digital signature
        Write-Host "Verifying digital signature..."
        $signature = Get-AuthenticodeSignature -FilePath $installerPath

        if ($signature.Status -ne "Valid") {
          Write-Error "Digital signature verification failed. Status: $($signature.Status)"
          exit 1
        }

        # Verify signer
        $signer = $signature.SignerCertificate.Subject
        Write-Host "Signed by: $signer"

        if ($signer -notmatch "Logitech") {
          Write-Error "Installer is not signed by Logitech. Signer: $signer"
          exit 1
        }

        Write-Host "Security verification passed"
      shell: pwsh

    - name: Install application
      run: |
        %TEMP%\installer.exe --silent
      shell: cmd

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run Python and update list if there was a software update
      run: |
        echo update=$(python update_list.py) >> $GITHUB_ENV
      shell: bash

    - name: Print env.update
      run: |
        echo ${{ env.update }}
      shell: bash

    - name: Create a PR if the list was updated
      if: ${{ env.update != '' }}
      uses: peter-evans/create-pull-request@v6
      with:
        branch: update
        commit-message: Update for G HUB version ${{ env.update }}
        title: Update for G HUB version ${{ env.update }}
